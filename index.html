<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Hábitos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Import Map for Gemini SDK -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.12.0"
  }
}
</script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #fff5f7;
            color: #4a4a4a;
            overflow-x: hidden;
        }
        
        /* Background Blobs */
        .blob-1 {
            position: fixed;
            top: -10%;
            left: -10%;
            width: 50%;
            height: 50%;
            background: rgba(251, 207, 232, 0.4);
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            pointer-events: none;
        }
        .blob-2 {
            position: fixed;
            bottom: -10%;
            right: -10%;
            width: 40%;
            height: 40%;
            background: rgba(219, 234, 254, 0.4);
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            pointer-events: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
    </style>
</head>
<body class="pb-32">

    <!-- Background -->
    <div class="blob-1"></div>
    <div class="blob-2"></div>

    <!-- App Container -->
    <div id="app" class="max-w-3xl mx-auto px-4 pt-8">
        <!-- Content will be injected here by JS -->
    </div>

    <!-- Navigation Bar -->
    <nav class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[90%] max-w-md bg-white/90 backdrop-blur-xl rounded-[2rem] shadow-2xl shadow-pink-200/50 border border-white/50 flex justify-between items-center px-8 h-20 z-50">
        <button onclick="router.navigate('daily')" class="nav-btn group flex flex-col items-center justify-center w-full h-full transition-colors" data-target="daily">
            <div class="p-1.5 rounded-2xl transition-all group-[.active]:bg-pink-100 group-[.active]:scale-110">
                <i data-lucide="layout-grid" class="w-6 h-6 text-gray-400 group-[.active]:text-pink-600 transition-colors"></i>
            </div>
            <span class="text-[10px] font-medium mt-1 text-pink-600 opacity-0 group-[.active]:opacity-100 transition-opacity">Diário</span>
        </button>
        <button onclick="router.navigate('calendar')" class="nav-btn group flex flex-col items-center justify-center w-full h-full transition-colors" data-target="calendar">
            <div class="p-1.5 rounded-2xl transition-all group-[.active]:bg-pink-100 group-[.active]:scale-110">
                <i data-lucide="calendar" class="w-6 h-6 text-gray-400 group-[.active]:text-pink-600 transition-colors"></i>
            </div>
            <span class="text-[10px] font-medium mt-1 text-pink-600 opacity-0 group-[.active]:opacity-100 transition-opacity">Mês</span>
        </button>
        <button onclick="router.navigate('stats')" class="nav-btn group flex flex-col items-center justify-center w-full h-full transition-colors" data-target="stats">
            <div class="p-1.5 rounded-2xl transition-all group-[.active]:bg-pink-100 group-[.active]:scale-110">
                <i data-lucide="bar-chart-2" class="w-6 h-6 text-gray-400 group-[.active]:text-pink-600 transition-colors"></i>
            </div>
            <span class="text-[10px] font-medium mt-1 text-pink-600 opacity-0 group-[.active]:opacity-100 transition-opacity">Stats</span>
        </button>
    </nav>

    <!-- Modal Template (Hidden) -->
    <div id="habit-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="ui.closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Novo Hábito</h2>
                <button onclick="ui.closeModal()" class="p-2 hover:bg-pink-100 rounded-full text-pink-500">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form onsubmit="app.handleCreateHabit(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                    <input type="text" id="habit-name" placeholder="Ex: Beber água" class="w-full px-4 py-3 rounded-2xl bg-pink-50/50 border border-pink-100 focus:ring-2 focus:ring-pink-200 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categoria</label>
                    <div class="flex flex-wrap gap-2" id="category-selector">
                        <!-- Filled by JS -->
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Cor</label>
                    <div class="flex gap-3" id="color-selector">
                        <!-- Filled by JS -->
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 py-3 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-2xl shadow-lg shadow-pink-200 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> Criar Hábito
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- Configuration ---
        // NOTE: In a pure HTML file, process.env is not available. 
        // Ideally, you would inject this or prompt for it.
        // For this demo to work, we handle the case gracefully.
        const API_KEY = window.process?.env?.API_KEY || ''; 
        
        let ai = null;
        if (API_KEY) {
            try {
                ai = new GoogleGenAI({ apiKey: API_KEY });
            } catch (e) { console.error("AI Init Error", e); }
        }

        // --- Data & State ---
        const CONSTANTS = {
            CATEGORIES: ['Saúde', 'Trabalho', 'Estudos', 'Espiritual', 'Lazer'],
            COLORS: ['#ec4899', '#8b5cf6', '#10b981', '#f59e0b', '#3b82f6']
        };

        const state = {
            habits: JSON.parse(localStorage.getItem('bloom_habits')) || [],
            currentView: 'daily',
            selectedDate: new Date().toISOString().split('T')[0],
            newHabit: { category: CONSTANTS.CATEGORIES[0], color: CONSTANTS.COLORS[0] }
        };

        // --- Core Logic ---
        const actions = {
            save() {
                localStorage.setItem('bloom_habits', JSON.stringify(state.habits));
                ui.render();
            },
            addHabit(name, category, color) {
                const habit = {
                    id: crypto.randomUUID(),
                    name,
                    category,
                    color,
                    completedDates: [],
                    createdAt: new Date().toISOString()
                };
                state.habits.push(habit);
                actions.save();
            },
            deleteHabit(id) {
                if(confirm('Excluir este hábito?')) {
                    state.habits = state.habits.filter(h => h.id !== id);
                    actions.save();
                }
            },
            toggleHabit(id, date) {
                const habit = state.habits.find(h => h.id === id);
                if (habit) {
                    if (habit.completedDates.includes(date)) {
                        habit.completedDates = habit.completedDates.filter(d => d !== date);
                    } else {
                        habit.completedDates.push(date);
                    }
                    actions.save();
                }
            },
            calculateStreak(dates) {
                if (!dates.length) return 0;
                const sorted = [...dates].sort((a, b) => new Date(b) - new Date(a));
                const today = new Date().toISOString().split('T')[0];
                let streak = 0;
                let checkDate = new Date();
                
                // Allow check from yesterday if today isn't done yet
                if (!sorted.includes(today)) {
                    checkDate.setDate(checkDate.getDate() - 1);
                }

                while (true) {
                    const dateStr = checkDate.toISOString().split('T')[0];
                    if (sorted.includes(dateStr)) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                return streak;
            }
        };

        // --- AI Service ---
        const aiService = {
            async getQuote() {
                if (!ai) return "Adicione sua API Key para receber inspiração mágica!";
                
                const names = state.habits.map(h => h.name).join(", ");
                const prompt = `
                    O usuário tem os hábitos: ${names || "nenhum ainda"}.
                    Crie uma frase motivacional curta (max 15 palavras), tom gentil/soft/aesthetic em Português.
                    Sem markdown.
                `;

                try {
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: prompt,
                    });
                    return response.text.trim();
                } catch (error) {
                    console.error(error);
                    return "Continue florescendo, um dia de cada vez!";
                }
            }
        };

        // --- Router ---
        const router = {
            navigate(view) {
                state.currentView = view;
                // Update Nav UI
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if(btn.dataset.target === view) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                ui.render();
            }
        };

        // --- UI Rendering ---
        const ui = {
            init() {
                this.setupModal();
                this.render();
                // Initialize Icons first time
                lucide.createIcons();
            },

            setupModal() {
                // Categories
                const catContainer = document.getElementById('category-selector');
                catContainer.innerHTML = CONSTANTS.CATEGORIES.map(cat => `
                    <button type="button" onclick="app.selectCategory('${cat}')" 
                        class="cat-btn px-3 py-1.5 rounded-xl text-sm border transition-all ${cat === state.newHabit.category ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-500 border-gray-200'}"
                        data-val="${cat}">
                        ${cat}
                    </button>
                `).join('');

                // Colors
                const colorContainer = document.getElementById('color-selector');
                colorContainer.innerHTML = CONSTANTS.COLORS.map(c => `
                    <button type="button" onclick="app.selectColor('${c}')"
                        class="color-btn w-8 h-8 rounded-full transition-transform ${c === state.newHabit.color ? 'scale-110 ring-2 ring-offset-2 ring-gray-200' : ''}"
                        style="background-color: ${c}"
                        data-val="${c}">
                    </button>
                `).join('');
            },

            openModal() {
                document.getElementById('habit-modal').classList.remove('hidden');
            },
            closeModal() {
                document.getElementById('habit-modal').classList.add('hidden');
                document.getElementById('habit-name').value = '';
            },

            render() {
                const app = document.getElementById('app');
                app.innerHTML = ''; // Clear

                if (state.currentView === 'daily') this.renderDaily(app);
                else if (state.currentView === 'calendar') this.renderCalendar(app);
                else if (state.currentView === 'stats') this.renderStats(app);

                // Re-init icons after DOM update
                lucide.createIcons();
            },

            async renderDaily(container) {
                // Header
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-8 animate-fade-in';
                header.innerHTML = `
                    <div>
                        <p class="text-pink-500 font-bold tracking-wider text-sm uppercase mb-1">Meus Hábitos</p>
                        <h1 class="text-3xl font-bold text-gray-800">Hoje</h1>
                    </div>
                    <button onclick="ui.openModal()" class="bg-pink-500 hover:bg-pink-600 text-white p-3 rounded-2xl shadow-lg shadow-pink-200 transition-all active:scale-95">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                `;
                container.appendChild(header);

                // AI Card
                const aiCard = document.createElement('div');
                aiCard.className = 'relative overflow-hidden bg-gradient-to-r from-pink-500 to-rose-400 rounded-3xl p-6 shadow-xl shadow-pink-200 mb-8 text-white animate-fade-in';
                aiCard.innerHTML = `
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="sparkles" class="w-24 h-24"></i></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="sparkles" class="w-4 h-4 text-yellow-200 animate-pulse"></i>
                            <span class="text-xs font-bold uppercase tracking-wider text-pink-100">Daily Inspiration</span>
                        </div>
                        <p id="ai-quote" class="text-lg font-medium leading-relaxed italic">Carregando magia...</p>
                    </div>
                `;
                container.appendChild(aiCard);
                // Load Quote
                aiService.getQuote().then(q => document.getElementById('ai-quote').innerText = `"${q}"`);

                // Habits List
                const today = new Date().toISOString().split('T')[0];
                const list = document.createElement('div');
                list.className = 'space-y-4';
                
                if (state.habits.length === 0) {
                    list.innerHTML = `<div class="text-center py-10 text-gray-400 border border-dashed border-pink-200 rounded-3xl">Comece sua jornada criando um hábito!</div>`;
                } else {
                    state.habits.forEach(h => {
                        const isDone = h.completedDates.includes(today);
                        const streak = actions.calculateStreak(h.completedDates);
                        const item = document.createElement('div');
                        item.className = `group relative flex items-center justify-between p-4 rounded-3xl transition-all duration-300 border ${isDone ? 'bg-white/80 border-pink-200 shadow-sm' : 'bg-white/40 border-white hover:bg-white/60'}`;
                        item.innerHTML = `
                            <div class="flex items-center gap-4">
                                <button onclick="app.toggle('${h.id}', '${today}')" class="w-12 h-12 rounded-full flex items-center justify-center transition-all border-2 ${isDone ? 'bg-pink-500 border-pink-500 text-white shadow-lg shadow-pink-200' : 'border-gray-300 text-transparent hover:border-pink-300'}">
                                    <i data-lucide="check" class="w-6 h-6 stroke-[3]"></i>
                                </button>
                                <div>
                                    <h3 class="font-semibold text-lg ${isDone ? 'text-gray-400 line-through decoration-pink-300' : 'text-gray-800'}">${h.name}</h3>
                                    <div class="flex items-center gap-2 text-xs">
                                        <span class="px-2 py-0.5 rounded-full bg-opacity-10 font-medium" style="background-color:${h.color}; color:${h.color}">${h.category}</span>
                                        ${streak > 0 ? `<span class="flex items-center gap-1 text-orange-500 font-bold"><i data-lucide="flame" class="w-3 h-3"></i> ${streak}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <button onclick="actions.deleteHabit('${h.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-red-500 transition-all">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        `;
                        list.appendChild(item);
                    });
                }
                container.appendChild(list);
            },

            renderCalendar(container) {
                const date = new Date(state.selectedDate);
                const year = date.getFullYear();
                const month = date.getMonth();
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();

                const monthName = date.toLocaleDateString('pt-BR', { month: 'long' });

                container.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Calendário</h1>
                    <div class="bg-white/70 backdrop-blur-md rounded-3xl p-6 shadow-lg shadow-pink-100 border border-white">
                        <div class="flex justify-between items-center mb-6 capitalize">
                            <button onclick="app.changeMonth(-1)" class="p-2 text-pink-500"><i data-lucide="chevron-left"></i></button>
                            <span class="text-xl font-bold text-gray-700">${monthName} ${year}</span>
                            <button onclick="app.changeMonth(1)" class="p-2 text-pink-500"><i data-lucide="chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center mb-2">
                            ${['D','S','T','Q','Q','S','S'].map(d => `<span class="text-xs font-bold text-gray-400">${d}</span>`).join('')}
                        </div>
                        <div class="grid grid-cols-7 gap-2" id="calendar-grid"></div>
                    </div>
                `;

                const grid = document.getElementById('calendar-grid');
                
                // Empty slots
                for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

                // Days
                for(let i=1; i<=daysInMonth; i++) {
                    const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const isToday = dStr === new Date().toISOString().split('T')[0];
                    const count = state.habits.filter(h => h.completedDates.includes(dStr)).length;
                    const total = state.habits.length;
                    const percent = total > 0 ? count / total : 0;

                    const btn = document.createElement('button');
                    btn.className = `aspect-square rounded-xl flex flex-col items-center justify-center text-sm font-medium relative ${isToday ? 'border-2 border-pink-400 text-pink-600' : 'text-gray-600 hover:bg-white'}`;
                    btn.innerHTML = `<span>${i}</span>`;
                    
                    if (count > 0) {
                        const dot = document.createElement('div');
                        dot.className = "w-1.5 h-1.5 rounded-full mt-1";
                        // Color intensity based on completion
                        if(percent === 1) dot.className += " bg-green-500";
                        else if(percent >= 0.5) dot.className += " bg-pink-500";
                        else dot.className += " bg-orange-300";
                        btn.appendChild(dot);
                    }
                    grid.appendChild(btn);
                }
            },

            renderStats(container) {
                const totalHabits = state.habits.length;
                const totalCompletions = state.habits.reduce((acc, h) => acc + h.completedDates.length, 0);
                const bestStreak = state.habits.length ? Math.max(...state.habits.map(h => actions.calculateStreak(h.completedDates))) : 0;

                container.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-8">Estatísticas</h1>
                    
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-3 gap-3 mb-8">
                        <div class="bg-white/70 backdrop-blur p-4 rounded-3xl text-center border border-white">
                            <div class="text-2xl font-bold text-gray-800">${bestStreak}</div>
                            <div class="text-xs text-gray-500">Recorde</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur p-4 rounded-3xl text-center border border-white">
                            <div class="text-2xl font-bold text-gray-800">${totalCompletions}</div>
                            <div class="text-xs text-gray-500">Total Feito</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur p-4 rounded-3xl text-center border border-white">
                            <div class="text-2xl font-bold text-gray-800">${totalHabits}</div>
                            <div class="text-xs text-gray-500">Hábitos</div>
                        </div>
                    </div>

                    <!-- Simple Bar Chart (HTML/CSS) -->
                    <div class="bg-white/60 backdrop-blur rounded-3xl p-6 shadow-sm border border-white">
                        <h3 class="font-bold text-gray-700 mb-6">Frequência</h3>
                        <div class="space-y-4">
                            ${state.habits.map(h => {
                                const max = Math.max(...state.habits.map(hb => hb.completedDates.length), 1);
                                const width = (h.completedDates.length / max) * 100;
                                return `
                                    <div>
                                        <div class="flex justify-between text-xs mb-1">
                                            <span class="font-medium">${h.name}</span>
                                            <span class="text-gray-500">${h.completedDates.length}</span>
                                        </div>
                                        <div class="h-3 w-full bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full transition-all duration-500" style="width: ${width}%; background-color: ${h.color}"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${state.habits.length === 0 ? '<p class="text-center text-gray-400 text-sm">Sem dados ainda.</p>' : ''}
                        </div>
                    </div>
                `;
            }
        };

        // --- Global Exports for HTML Event Handlers ---
        window.router = router;
        window.actions = actions;
        window.ui = ui;
        
        // Helper object for clean event handlers in HTML
        window.app = {
            handleCreateHabit(e) {
                e.preventDefault();
                const name = document.getElementById('habit-name').value;
                if(name) {
                    actions.addHabit(name, state.newHabit.category, state.newHabit.color);
                    ui.closeModal();
                }
            },
            selectCategory(cat) {
                state.newHabit.category = cat;
                ui.setupModal(); // Re-render selectors to show active state
            },
            selectColor(color) {
                state.newHabit.color = color;
                ui.setupModal();
            },
            toggle(id, date) {
                actions.toggleHabit(id, date);
                ui.render(); // Re-render to show check
            },
            changeMonth(delta) {
                const curr = new Date(state.selectedDate);
                curr.setMonth(curr.getMonth() + delta);
                state.selectedDate = curr.toISOString().split('T')[0];
                ui.render();
            }
        };

        // Init
        ui.init();
    </script>
</body>
</html>